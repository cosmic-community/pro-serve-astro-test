---
import type { Testimonial } from '../types';

export interface Props {
  testimonial: Testimonial;
}

const { testimonial } = Astro.props;

const renderStars = (rating: number) => {
  return Array.from({ length: 5 }, (_, index) => {
    const filled = index < rating ? 'text-yellow-400' : 'text-secondary-300';
    return { filled };
  });
};
---

<div class="bg-white rounded-lg shadow-md p-6">
  <div class="flex items-center mb-4">
    {testimonial.metadata?.client_photo && (
      <img 
        src={`${testimonial.metadata.client_photo.imgix_url}?w=120&h=120&fit=crop&auto=format,compress`}
        alt={testimonial.metadata?.client_name || 'Client photo'}
        class="w-12 h-12 rounded-full object-cover mr-4"
        loading="lazy"
      />
    )}
    
    <div>
      <h3 class="font-semibold text-gray-900">
        {testimonial.metadata?.client_name}
      </h3>
      <p class="text-sm text-gray-600">
        {testimonial.metadata?.client_title}
        {testimonial.metadata?.company && (
          <span> â€¢ {testimonial.metadata.company}</span>
        )}
      </p>
    </div>
  </div>

  {testimonial.metadata?.testimonial && (
    <blockquote class="text-gray-700 mb-4 italic">
      "{testimonial.metadata.testimonial}"
    </blockquote>
  )}

  {testimonial.metadata?.rating && (
    <div class="flex items-center mb-4">
      <div class="flex text-yellow-400">
        {renderStars(Number(testimonial.metadata.rating.key)).map(({ filled }) => (
          <svg
            class={`w-5 h-5 ${filled ? 'text-yellow-400' : 'text-secondary-300'}`}
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"
              clip-rule="evenodd"
            />
          </svg>
        ))}
      </div>
      <span class="ml-2 text-sm text-gray-600">
        {testimonial.metadata.rating.value}
      </span>
    </div>
  )}

  {testimonial.metadata?.related_service && (
    <div class="border-t border-gray-200 pt-4">
      <div class="text-sm text-gray-600">
        <span class="font-medium">Service:</span>
        <span class="text-primary-600 ml-1">
          {testimonial.metadata.related_service.metadata?.name || testimonial.metadata.related_service.title}
        </span>
      </div>
    </div>
  )}
</div>